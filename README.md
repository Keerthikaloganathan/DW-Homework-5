# -*- coding: utf-8 -*-
"""homework4_dag.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/12ebJAyz_nsx77wm3t8s055t6n_l2Gjxa
"""

from airflow import DAG
from airflow.models import Variable
from airflow.decorators import task
from airflow.providers.snowflake.hooks.snowflake import SnowflakeHook
from datetime import datetime, timedelta
import requests

# Default arguments for the DAG
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': 1,
    'retry_delay': timedelta(minutes=5),
}

# Initialize the DAG
with DAG(
    dag_id='homework_4_dag',
    default_args=default_args,
    description='ETL DAG for Homework 4 using Cloud Composer and Snowflake',
    start_date=datetime(2024, 9, 21),
    catchup=False,
    schedule_interval='@daily',
    tags=['homework', 'etl'],
) as dag:

    # Function to get a Snowflake connection using SnowflakeHook
    def return_snowflake_conn():
        hook = SnowflakeHook(snowflake_conn_id='snowflake_conn')
        conn = hook.get_conn()
        return conn.cursor()

    # Task 1: Extract stock data from Alpha Vantage API
    @task
    def extract_stock_data():
        symbol = "GOOG"
        api_key = Variable.get("alpha_vantage_api_key")  # Get the API key from Airflow Variables
        url = f"https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol={symbol}&apikey={api_key}"
        response = requests.get(url)
        data = response.json()
        return data.get("Time Series (Daily)", {})

    # Task 2: Transform the data into a list of records
    @task
    def transform_stock_data(time_series: dict):
        records = []
        dates = list(time_series.keys())[:90]  # Limit to last 90 days

        for date in dates:
            stock_info = time_series[date]
            record = {
                "date": date,
                "open": float(stock_info["1. open"]),
                "high": float(stock_info["2. high"]),
                "low": float(stock_info["3. low"]),
                "close": float(stock_info["4. close"]),
                "volume": int(stock_info["5. volume"])
            }
            records.append(record)

        return records

    # Task 3: Load the records into Snowflake
    @task
    def load_to_snowflake(records):
        # Get a Snowflake connection cursor
        cursor = return_snowflake_conn()
        staging_table = "dev.raw_data.temp_stock_prices"
        target_table = "dev.raw_data.stock_prices"

        try:
            cursor.execute("BEGIN;")

            # Create or replace the target table
            cursor.execute(f"""
                CREATE OR REPLACE TABLE {target_table} (
                    date DATE primary key,
                    open FLOAT,
                    high FLOAT,
                    low FLOAT,
                    close FLOAT,
                    volume INT
                );
            """)

            # Create or replace the staging table
            cursor.execute(f"""
                CREATE OR REPLACE TABLE {staging_table} (
                    date DATE primary key,
                    open FLOAT,
                    high FLOAT,
                    low FLOAT,
                    close FLOAT,
                    volume INT
                );
            """)

            # Insert records into the staging table
            for record in records:
                cursor.execute(f"""
                    INSERT INTO {staging_table} (date, open, high, low, close, volume)
                    VALUES ('{record['date']}', {record['open']}, {record['high']}, {record['low']}, {record['close']}, {record['volume']});
                """)

            # Merge staging table into target table using UPSERT
            cursor.execute(f"""
                MERGE INTO {target_table} AS target
                USING {staging_table} AS stage
                ON target.date = stage.date
                WHEN MATCHED THEN
                    UPDATE SET
                        target.open = stage.open,
                        target.high = stage.high,
                        target.low = stage.low,
                        target.close = stage.close,
                        target.volume = stage.volume
                WHEN NOT MATCHED THEN
                    INSERT (date, open, high, low, close, volume)
                    VALUES (stage.date, stage.open, stage.high, stage.low, stage.close, stage.volume);
            """)

            # Commit the transaction
            cursor.execute("COMMIT;")
        except Exception as e:
            cursor.execute("ROLLBACK;")
            print(e)
            raise e
        finally:
            cursor.close()

    # Set up the task dependencies
    stock_data = extract_stock_data()
    transformed_data = transform_stock_data(stock_data)
    load_to_snowflake(transformed_data)
